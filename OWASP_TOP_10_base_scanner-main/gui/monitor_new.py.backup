"""
ìƒˆë¡œìš´ GUI ëª¨ë‹ˆí„° - ëª¨ë“ˆí™”ëœ êµ¬ì¡°
ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ë„êµ¬ì˜ ë©”ì¸ GUI ì• í”Œë¦¬ì¼€ì´ì…˜
"""
import tkinter as tk
import sys
import os
from tkinter import messagebox

# í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
current_dir = os.path.dirname(__file__)
sys.path.append(current_dir)
sys.path.append(os.path.join(current_dir, '..'))

# ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•œ í™˜ê²½ ì„¤ì •
os.environ['TK_SILENCE_DEPRECATION'] = '1'

# CustomTkinter ë¹„í™œì„±í™” (ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ë°©ì§€)
# í™˜ê²½ ë³€ìˆ˜ë¡œ CustomTkinter ì‚¬ìš© ì—¬ë¶€ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
# ì˜ˆ: USE_CUSTOMTKINTER=1 python3 run_monitor.py
USE_CUSTOMTKINTER = os.environ.get('USE_CUSTOMTKINTER', '0') == '1'

CTK_AVAILABLE = False
if USE_CUSTOMTKINTER:
    try:
        import customtkinter as ctk

        # ì•ˆì „í•œ í…Œë§ˆ ì„¤ì •
        try:
            ctk.set_appearance_mode("light")  # system ëŒ€ì‹  light ì‚¬ìš©
            ctk.set_default_color_theme("blue")
            CTK_AVAILABLE = True
            print("âœ… CustomTkinter ë¡œë“œ ì„±ê³µ")
            print("âœ… CustomTkinter í…Œë§ˆ ì„¤ì • ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ CustomTkinter í…Œë§ˆ ì„¤ì • ì‹¤íŒ¨: {e}")
            CTK_AVAILABLE = False

    except ImportError as e:
        print(f"âš ï¸ CustomTkinter ë¡œë“œ ì‹¤íŒ¨: {e}")
        print("ğŸ“Œ tkinterë¡œ í´ë°±í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤")
        CTK_AVAILABLE = False
else:
    print("ğŸ“Œ í‘œì¤€ tkinter ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤ (CustomTkinter ë¹„í™œì„±í™”)")

# ë¡œì»¬ ëª¨ë“ˆ import
try:
    from main_window import MainWindow
    from components import UIComponents
    from utils import load_user_info, validate_url
    print("âœ… ë¡œì»¬ ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ")
except ImportError as e:
    print(f"âŒ ë¡œì»¬ ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨: {e}")
    messagebox.showerror("ëª¨ë“ˆ ì˜¤ë¥˜", f"GUI ëª¨ë“ˆì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}")
    sys.exit(1)

class SecurityTestGUI:
    """ë³´ì•ˆ ê²€ì‚¬ GUI ë©”ì¸ í´ë˜ìŠ¤"""
    
    def __init__(self):
        self.root = None
        self.main_window = None
        
        # ì•ˆì „í•œ ì´ˆê¸°í™”
        if not self.setup_root_window():
            raise Exception("ìœˆë„ìš° ì´ˆê¸°í™” ì‹¤íŒ¨")
            
        try:
            print("ğŸ”§ MainWindow ì´ˆê¸°í™” ì‹œì‘...")
            self.main_window = MainWindow(self.root)
            print("âœ… MainWindow ì´ˆê¸°í™” ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ MainWindow ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            import traceback
            traceback.print_exc()
            self.main_window = None
            
        self.setup_error_handling()
        
    def setup_root_window(self):
        """ë£¨íŠ¸ ìœˆë„ìš° ì„¤ì •"""
        try:
            # CustomTkinter ì‚¬ìš©í•˜ì§€ ì•Šê³  í‘œì¤€ tkinterë§Œ ì‚¬ìš©
            # (ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ë°©ì§€)
            self.root = tk.Tk()
            print("âœ… Tkinter ìœˆë„ìš° ìƒì„±")

            # ê¸°ë³¸ ì„¤ì •
            self.root.title("ğŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ë„êµ¬ v2.0")
            self.root.geometry("900x700")

            # ìµœì†Œ ì°½ í¬ê¸° ì„¤ì •
            self.root.minsize(800, 600)

            # ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬
            self.root.protocol("WM_DELETE_WINDOW", self.on_closing)

            return True

        except Exception as e:
            print(f"âŒ ìœˆë„ìš° ì„¤ì • ì‹¤íŒ¨: {e}")
            return False
        
    def setup_error_handling(self):
        """ì „ì—­ ì—ëŸ¬ í•¸ë“¤ë§ ì„¤ì •"""
        def handle_exception(exc_type, exc_value, exc_traceback):
            if issubclass(exc_type, KeyboardInterrupt):
                sys.__excepthook__(exc_type, exc_value, exc_traceback)
                return
                
            error_msg = f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n{exc_type.__name__}: {exc_value}"
            print(f"âŒ ì „ì—­ ì˜ˆì™¸: {error_msg}")
            
            # GUIê°€ ì•„ì§ ì‚´ì•„ìˆë‹¤ë©´ ë©”ì‹œì§€ ë°•ìŠ¤ í‘œì‹œ
            try:
                messagebox.showerror("ì˜¤ë¥˜", error_msg)
            except:
                print("GUI ì‘ë‹µ ì—†ìŒ - ì½˜ì†”ë¡œë§Œ ì¶œë ¥")
                
        sys.excepthook = handle_exception
        
    def run(self):
        """GUI ì‹¤í–‰"""
        try:
            print("ğŸš€ GUI ì‹œì‘...")
            
            # ìœˆë„ìš° ì„¤ì • í™•ì¸
            if not hasattr(self, 'root') or self.root is None:
                print("âŒ ìœˆë„ìš°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                return
            
            # ì„¤ì • íŒŒì¼ í™•ì¸
            self.check_configuration()
            
            print("ğŸ”§ UI êµ¬ì„± ì‹œì‘...")
            
            # ë©”ì¸ UI ì„¤ì • (ì•ˆì „í•˜ê²Œ)
            try:
                if self.main_window:
                    print("ğŸ”§ ë©”ì¸ UI ì„¤ì • ì‹œì‘...")
                    self.main_window.setup_main_ui()
                    print("âœ… GUI ì´ˆê¸°í™” ì™„ë£Œ")
                else:
                    print("âš ï¸ MainWindowê°€ ì—†ì–´ì„œ ê¸°ë³¸ UIë¡œ ì„¤ì •")
                    self.setup_fallback_ui()
            except Exception as ui_error:
                print(f"âŒ UI ì´ˆê¸°í™” ì‹¤íŒ¨: {ui_error}")
                import traceback
                traceback.print_exc()
                # UI ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ UIë¡œ í´ë°±
                self.setup_fallback_ui()
            
            # ë©”ì¸ ë£¨í”„ ì‹¤í–‰
            self.root.mainloop()
            
        except Exception as e:
            error_msg = f"GUI ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"
            print(f"âŒ {error_msg}")
            try:
                messagebox.showerror("ì‹œì‘ ì˜¤ë¥˜", error_msg)
            except:
                pass
            
    def check_configuration(self):
        """ì„¤ì • íŒŒì¼ í™•ì¸ ë° ì´ˆê¸°í™”"""
        try:
            config = load_user_info()
            
            # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
            required_dirs = ["etc", "logs", "results"]
            for dir_name in required_dirs:
                dir_path = os.path.join(os.path.dirname(current_dir), dir_name)
                os.makedirs(dir_path, exist_ok=True)
                
            print("âœ… ì„¤ì • í™•ì¸ ì™„ë£Œ")
            
        except Exception as e:
            print(f"âš ï¸ ì„¤ì • í™•ì¸ ì‹¤íŒ¨: {e}")
            
    def setup_fallback_ui(self):
        """ê¸°ë³¸ í´ë°± UI ì„¤ì •"""
        try:
            print("ğŸ”„ ê¸°ë³¸ UIë¡œ í´ë°± ì¤‘...")

            # í‘œì¤€ tkinter ë¼ë²¨ ì‚¬ìš©
            label = tk.Label(
                self.root,
                text="ğŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ë„êµ¬\n\nUI ì´ˆê¸°í™” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê¸°ë³¸ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.",
                font=("Arial", 14),
                justify="center"
            )
            label.pack(expand=True)

            print("âœ… ê¸°ë³¸ UI ì„¤ì • ì™„ë£Œ")

        except Exception as e:
            print(f"âŒ ê¸°ë³¸ UI ì„¤ì •ë„ ì‹¤íŒ¨: {e}")
            
    def on_closing(self):
        """ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬"""
        try:
            # ì‹¤í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
            if hasattr(self.main_window, 'dast_view') and hasattr(self.main_window.dast_view, 'test_runner'):
                if self.main_window.dast_view.test_runner.is_testing:
                    if messagebox.askyesno("í™•ì¸", "ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ë§ë¡œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                        # í…ŒìŠ¤íŠ¸ ì¤‘ì§€
                        self.main_window.dast_view.test_runner.stop_test()
                        self.root.after(1000, self.root.destroy)  # 1ì´ˆ í›„ ì¢…ë£Œ
                    return
                    
            self.root.destroy()
            
        except Exception as e:
            print(f"âš ï¸ ì¢…ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
            self.root.destroy()

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print("=" * 50)
    print("ğŸ›¡ï¸  ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ë„êµ¬ GUI v2.0")
    print("=" * 50)
    
    try:
        # GUI ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì‹¤í–‰
        app = SecurityTestGUI()
        app.run()
        
    except KeyboardInterrupt:
        print("\nğŸ›‘ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Exception as e:
        print(f"âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        print("ğŸ‘‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ")

if __name__ == "__main__":
    main()